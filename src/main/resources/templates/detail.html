<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${board.title}"></title>
    <link rel="stylesheet" th:href="@{/css/board.css}"/>

    <script th:src="|https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${naverMapsClientId}&callback=initMap|"></script>
    <script th:src="@{/js/markerclustering.js}" defer></script>

</head>
<body>
<div th:replace="~{fragments/header :: headerFragment}"></div>

<div class="container board-detail">
    <h1 th:text="${board.title}"></h1>
    <div class="info">
        <span>작성자: <span th:text="${board.nickname}"></span></span> |
        <span>조회수: <span th:text="${board.viewCnt}"></span></span> |
        <span>작성일: <span th:text="${#temporals.format(board.redate, 'yyyy-MM-dd HH:mm')}"></span></span>
        <span th:if="${board.modifiedAt != null}">
            | <span>수정: <span th:text="${#temporals.format(board.modifiedAt, 'yyyy-MM-dd HH:mm')}"></span></span>
        </span>
    </div>
    <hr>
    <div class="content-area">
        <div class="image-area" th:if="${board.imageBase64 != null}">
            <img th:src="'data:image/jpeg;base64,' + ${board.imageBase64}" style="max-width: 100%;" />
        </div>
        <div class="content-text" th:text="${board.content}"></div>
    </div>
    <hr>

    <div th:if="${board.latitude != null and board.longitude != null}">
        <h3>연관된 수거함 위치</h3>
        <div id="map" style="width:100%;height:400px;border:1px solid #ccc;"></div>
    </div>

    <div class="button-area" style="margin-top: 20px;">
        <a th:href="@{/share}" class="btn">목록보기</a>
        <span th:if="${#authorization.expression('isAuthenticated() and (principal.userId == #vars.board.userId or hasRole(''ROLE_ADMIN''))')}">
            <a th:href="@{/updateform(boardId=${board.boardId})}" class="btn">수정하기</a>
            <a th:href="@{/delete(boardId=${board.boardId})}" class="btn btn-danger" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제하기</a>
        </span>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    // Thymeleaf를 통해 서버에서 직접 board 객체의 데이터를 안전하게 가져옵니다.
    const boardData = {
        lat: /*[[${board.latitude}]]*/ null,
        lng: /*[[${board.longitude}]]*/ null
    };

    // board 데이터에 위도(lat)와 경도(lng) 값이 있을 경우에만 지도를 생성합니다.
    if (boardData.lat && boardData.lng) {
        const map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(boardData.lat, boardData.lng),
            zoom: 15,
            // 지도 컨트롤 비활성화 (보기 전용)
            scaleControl: false,
            logoControl: false,
            mapDataControl: false,
            zoomControl: true,
            minZoom: 6
        });

        // 해당 위치에 마커를 생성합니다.
        new naver.maps.Marker({
            position: new naver.maps.LatLng(boardData.lat, boardData.lng),
            map: map
        });
    }

    /*]]>*/
</script>

</body>
</html>