<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>ì˜ë¥˜ ìˆ˜ê±°í•¨ ì§€ë„</title>

    <script th:src="|https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${naverMapsClientId}&callback=initMap|"></script>
    <script th:src="@{/js/markerclustering.js}" defer></script>

    <style>
        /* CSSëŠ” ë³€ê²½ ì—†ìŒ */
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; display: flex; flex-direction: column; }
        #map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .cluster {
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }
        #research-btn {
            position: absolute; top: 60px;
            left: 50%; transform: translateX(-50%); z-index: 100;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            background-color: #6c5ce7;
            color: white;
            border: none;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        #recenter-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            padding: 10px;
            font-size: 20px;
            background-color: white;
            color: #6c5ce7;
            border: 2px solid #6c5ce7;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .iw-inner {
            padding: 10px;
            width: 300px;
            position: relative;
        }
        .iw-inner h4 { margin-top: 0; }
        .post-list { max-height: 150px; overflow-y: auto; margin: 10px 0; }
        .post-item { border-bottom: 1px solid #eee; padding: 5px 0; }
        .post-item strong { color: #6c5ce7; }
        .post-form textarea { width: 95%; margin-bottom: 5px; }
        .post-form input[type="file"] { margin-bottom: 5px; }
        .iw-wish-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 24px;
            cursor: pointer;
            border: none;
            background: none;
            line-height: 1;
        }
        .iw-wish-btn:not(.active) { color: gray; }
        .iw-wish-btn.active { color: gold; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: headerFragment}"></div>

<div id="map-container">
    <div id="map"></div>
    <button id="research-btn">ì´ ìœ„ì¹˜ì—ì„œ ë‹¤ì‹œ ê²€ìƒ‰</button>
    <button id="recenter-btn" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“</button>
</div>

<script>
    // ... (map, markers, clusterer ë“± ë³€ìˆ˜ ì„ ì–¸ì€ ë™ì¼) ...
    let map;
    let markers = [];
    let clusterer = null;
    let selectedInfoWindow = null;
    let currentBinId = null;
    let userWishes = new Set();

    // ... (initMap, recenterToMyLocation, fetchUserWishes, makeClusterer í•¨ìˆ˜ëŠ” ë™ì¼) ...
    function initMap() {
        map = new naver.maps.Map("map", { center: new naver.maps.LatLng(37.6, 127.1), zoom: 13, mapDataControl: false, zoomControl: true, zoomControlOptions: { position: naver.maps.Position.TOP_LEFT } });
        document.getElementById('research-btn').addEventListener('click', updateMarkers);
        document.getElementById('recenter-btn').addEventListener('click', recenterToMyLocation);
        naver.maps.Event.addListener(map, 'click', () => { if (selectedInfoWindow) { selectedInfoWindow.close(); selectedInfoWindow = null; } currentBinId = null; });
        fetchUserWishes();
        updateMarkers();
    }
    function recenterToMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition( (position) => { const center = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude); map.setCenter(center); map.setZoom(16, true); }, (error) => { console.error("Geolocation Error:", error); let message = "ì‚¬ìš©ì ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; if (error.code === 1) { message = "ìœ„ì¹˜ ì •ë³´ ì‚¬ìš© ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤."; } alert(message); }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 } );
        } else { alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
    }
    function fetchUserWishes() {
        fetch('/api/wish/list', { credentials: 'include' }) .then(res => res.json()) .then(binIds => { userWishes = new Set(binIds); }) .catch(err => console.error('ì¦ê²¨ì°¾ê¸° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', err));
    }
    function makeClusterer() { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */ return new MarkerClustering({ minClusterSize: 2, maxZoom: 16, map: map, markers: markers, disableClickZoom: false, gridSize: 120, icons: [{ content: `<div class="cluster"></div>`, size: new naver.maps.Size(40, 40), anchor: new naver.maps.Point(20, 20) }], stylingFunction: function (clusterMarker, count) { const clusterDiv = clusterMarker.getElement().querySelector('div'); const size = Math.min(60, 20 + Math.sqrt(count) * 2); const fontSize = Math.max(12, size / 3.5); clusterDiv.textContent = count; clusterDiv.style.width = `${size}px`; clusterDiv.style.height = `${size}px`; clusterDiv.style.lineHeight = `${size}px`; clusterDiv.style.fontSize = `${fontSize}px`; if (count < 10) { clusterDiv.style.backgroundColor = '#ffd5e1'; } else if (count < 50) { clusterDiv.style.backgroundColor = '#ff88bc'; } else if (count < 100) { clusterDiv.style.backgroundColor = '#c637ff'; } else if (count < 500) { clusterDiv.style.backgroundColor = '#000bff'; } else { clusterDiv.style.backgroundColor = '#739bff'; } } }); }


    // VVV ìˆ˜ì •ëœ ë¶€ë¶„ 1 VVV: toggleWish í•¨ìˆ˜ ìˆ˜ì •
    function toggleWish(binId) {
        const isWished = userWishes.has(binId);
        // CSRF ë³´í˜¸ ë•Œë¬¸ì— ì¦ê²¨ì°¾ê¸° ì¶”ê°€/ì‚­ì œëŠ” ëª¨ë‘ POST ë°©ì‹ìœ¼ë¡œ í†µì¼í•˜ëŠ” ê²ƒì´ ê°„ë‹¨í•©ë‹ˆë‹¤.
        const method = 'POST';
        const apiUrl = `/api/wish/${isWished ? 'remove' : 'add'}/${binId}`;

        // header.htmlì— ìˆëŠ” CSRF í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const csrfToken = document.querySelector('header input[name="_csrf"]')?.value;
        const csrfHeaderName = document.querySelector('header input[name="_csrf_header"]')?.name;

        const headers = {};
        if (csrfHeaderName && csrfToken) {
            headers[csrfHeaderName] = csrfToken;
        }

        fetch(apiUrl, {
            method: method,
            headers: headers,
            credentials: 'include'
        })
            .then(res => {
                // 401(ë¯¸ì¸ì¦) ë˜ëŠ” 403(ê¶Œí•œì—†ìŒ/CSRFì‹¤íŒ¨) ìƒíƒœ ì½”ë“œë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
                if (res.status === 401 || res.status === 403) {
                    alert('ì¦ê²¨ì°¾ê¸° ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login.html';
                    return Promise.reject('ë¡œê·¸ì¸ í•„ìš”');
                }
                if (!res.ok) return res.json().then(err => Promise.reject(err.message || 'ì²˜ë¦¬ ì‹¤íŒ¨'));
                return res.json();
            })
            .then(data => {
                alert(data.message);
                const wishBtn = document.getElementById(`iw-wish-btn-${binId}`);
                if (isWished) {
                    userWishes.delete(binId);
                    if (wishBtn) {
                        wishBtn.classList.remove('active');
                        wishBtn.textContent = 'â˜†';
                    }
                } else {
                    userWishes.add(binId);
                    if (wishBtn) {
                        wishBtn.classList.add('active');
                        wishBtn.textContent = 'â˜…';
                    }
                }
            })
            .catch(err => {
                if (err !== 'ë¡œê·¸ì¸ í•„ìš”') console.error("Wish Error:", err);
            });
    }

    // ... (updateMarkers í•¨ìˆ˜ëŠ” ê¸°ì¡´ ì½”ë“œì™€ ê±°ì˜ ë™ì¼, ë‚´ë¶€ì˜ submitPost í˜¸ì¶œ ë¶€ë¶„ë§Œ ìˆ˜ì •) ...
    function updateMarkers() { const bounds = map.getBounds(); const sw = bounds.getSW(); const ne = bounds.getNE(); const apiUrl = `/api/clothing-bins/in-bounds?swLat=${sw.lat()}&swLng=${sw.lng()}&neLat=${ne.lat()}&neLng=${ne.lng()}`; fetch(apiUrl) .then(res => res.ok ? res.json() : Promise.reject('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜')) .then(data => { markers.forEach(m => m.setMap(null)); if (clusterer) clusterer.setMap(null); markers = []; markers = data.map(bin => { const marker = new naver.maps.Marker({ position: new naver.maps.LatLng(bin.latitude, bin.longitude) }); naver.maps.Event.addListener(marker, 'click', () => { if (selectedInfoWindow) selectedInfoWindow.close(); currentBinId = bin.id; fetch(`/api/markers/${bin.id}/posts`, { credentials: 'include' }) .then(res => res.json()) .then(posts => { let postHtml = posts.map(post => `<div class="post-item"><strong>${post.authorNickname}</strong>: ${post.content}${post.imageBase64 ? `<br><img src="data:image/jpeg;base64,${post.imageBase64}" style="max-width:100%;"/>` : ''}</div>` ).join(''); if(posts.length === 0) postHtml = '<p>ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; const isWished = userWishes.has(bin.id); const wishClass = isWished ? 'active' : ''; const wishText = isWished ? 'â˜…' : 'â˜†'; const wishBtnHtml = `<button id="iw-wish-btn-${bin.id}" class="iw-wish-btn ${wishClass}" onclick="toggleWish(${bin.id})">${wishText}</button>`;

        // VVV ìˆ˜ì •ëœ ë¶€ë¶„ 2 VVV: submitPost í˜¸ì¶œ ì‹œ CSRF í† í°ì„ ì°¾ê¸° ìœ„í•œ ì •ë³´ëŠ” í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì œê±°í•©ë‹ˆë‹¤.
        const formHtml = `<div class="post-form"><hr><h5>ë¦¬ë·° ë‚¨ê¸°ê¸°</h5><form id="post-form-${bin.id}"><textarea name="content" rows="3" placeholder="ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea><br><input type="file" name="image" accept="image/*"><br><button type="button" onclick="submitPost(${bin.id})">ë“±ë¡</button></form></div>`;

        const infoWindowContent = `<div class="iw-inner">${wishBtnHtml}<h4>${bin.roadAddress || bin.landLotAddress}</h4><div class="post-list">${postHtml}</div>${formHtml}</div>`; const infoWindow = new naver.maps.InfoWindow({ content: infoWindowContent, maxWidth: 350 }); infoWindow.open(map, marker); selectedInfoWindow = infoWindow; }); }); return marker; }); clusterer = makeClusterer(); }) .catch(err => console.error('ë§ˆì»¤ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err)); }

    // VVV ìˆ˜ì •ëœ ë¶€ë¶„ 3 VVV: submitPost í•¨ìˆ˜ ìˆ˜ì •
    function submitPost(binId) {
        const form = document.getElementById(`post-form-${binId}`);
        const formData = new FormData(form);

        // header.htmlì— ìˆëŠ” CSRF í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const csrfToken = document.querySelector('header input[name="_csrf"]')?.value;
        const csrfHeaderName = document.querySelector('header input[name="_csrf_header"]')?.name;

        const headers = {};
        if (csrfHeaderName && csrfToken) {
            headers[csrfHeaderName] = csrfToken;
        }

        fetch(`/api/markers/${binId}/posts`, {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: formData
        })
            .then(res => {
                if (res.status === 401 || res.status === 403) {
                    alert('ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login.html';
                    return Promise.reject('ë¡œê·¸ì¸ í•„ìš”');
                }
                if (!res.ok) return res.json().then(err => Promise.reject(err.message || 'ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨'));
                return res.json();
            })
            .then(data => {
                alert(data.message);
                if (selectedInfoWindow) {
                    const markerPosition = selectedInfoWindow.getPosition();
                    selectedInfoWindow.close();
                    const marker = markers.find(m => m.getPosition().equals(markerPosition));
                    if (marker) naver.maps.Event.trigger(marker, 'click');
                }
            })
            .catch(err => {
                if (err !== 'ë¡œê·¸ì¸ í•„ìš”') console.error("Error:", err);
            });
    }

</script>
</body>
</html>