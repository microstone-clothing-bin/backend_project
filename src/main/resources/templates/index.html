<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>의류 수거함 지도</title>

    <script th:src="|https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${naverMapsClientId}&callback=initMap|"></script>
    <script th:src="@{/js/markerclustering.js}" defer></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; display: flex; flex-direction: column; }
        #map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .cluster {
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }
        #research-btn {
            position: absolute; top: 60px;
            left: 50%; transform: translateX(-50%); z-index: 100;
            /* 임시로 padding값, 폰트 사이즈 조정 (추후 디자이너님과 협의 해야함) */
            padding: 8px 12px;
            font-size: 12px;

            font-weight: bold;
            background-color: #6c5ce7;
            color: white;
            border: none;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        /* 내 위치로 돌아가기 버튼 스타일 */
        #recenter-btn {
            position: absolute;
            bottom: 20px; /* 좌측 하단 위치 */
            left: 20px;
            z-index: 100;
            padding: 10px;
            font-size: 20px;
            background-color: white;
            color: #6c5ce7; /* 아이콘 색상 */
            border: 2px solid #6c5ce7;
            border-radius: 50%; /* 원형 버튼 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        /* InfoWindow 내부 스타일 */
        .iw-inner {
            padding: 10px;
            width: 300px;
            position: relative;
        }
        .iw-inner h4 { margin-top: 0; }
        .post-list { max-height: 150px; overflow-y: auto; margin: 10px 0; }
        .post-item { border-bottom: 1px solid #eee; padding: 5px 0; }
        .post-item strong { color: #6c5ce7; }
        .post-form textarea { width: 95%; margin-bottom: 5px; }
        .post-form input[type="file"] { margin-bottom: 5px; }

        /* InfoWindow 내부의 즐겨찾기 버튼 스타일 */
        .iw-wish-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 24px;
            cursor: pointer;
            border: none;
            background: none;
            line-height: 1;
        }
        .iw-wish-btn:not(.active) {
            color: gray;
        }
        .iw-wish-btn.active {
            color: gold;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: headerFragment}"></div>

<div id="map-container">
    <div id="map"></div>
    <button id="research-btn">이 위치에서 다시 검색</button>
    <button id="recenter-btn" title="내 위치로 이동">📍</button>
</div>

<script>
    let map; // 지도 객체
    let markers = []; // 마커 배열
    let clusterer = null; // 클러스터 객체
    let selectedInfoWindow = null; // 현재 열린 InfoWindow

    let currentBinId = null; // 현재 InfoWindow가 열린 수거함 ID 저장
    let userWishes = new Set(); // 유저의 현재 찜 목록을 저장할 Set

    // 지도 초기화
    function initMap() {
        map = new naver.maps.Map("map", {
            center: new naver.maps.LatLng(37.6, 127.1), // 초기 지도 중심
            zoom: 13,
            mapDataControl: false,
            zoomControl: true,
            zoomControlOptions: { position: naver.maps.Position.TOP_LEFT }
        });

        // '여기서 다시 검색' 버튼 클릭 시 마커 업데이트
        document.getElementById('research-btn').addEventListener('click', updateMarkers);

        // '내 위치로 이동' 버튼 클릭 시 함수 연결
        document.getElementById('recenter-btn').addEventListener('click', recenterToMyLocation);

        // 지도 클릭 시 열린 InfoWindow 닫기
        naver.maps.Event.addListener(map, 'click', () => {
            if (selectedInfoWindow) {
                selectedInfoWindow.close();
                selectedInfoWindow = null;
            }
            currentBinId = null;
        });

        // 페이지 로드 시 찜 목록 로딩
        fetchUserWishes();
        updateMarkers(); // 최초 로딩 시 한 번 마커 로딩
    }

    function recenterToMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const center = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);

                    // 지도를 현재 위치로 이동
                    map.setCenter(center);
                    // 줌 레벨을 적절히 확대 (ex): 16)
                    map.setZoom(16, true);

                },
                (error) => {
                    console.error("Geolocation Error:", error);
                    let message = "사용자 위치를 찾을 수 없습니다. 위치 권한을 확인해주세요.";
                    if (error.code === 1) {
                        message = "위치 정보 사용 권한이 거부되었습니다. 브라우저 설정을 확인해주세요.";
                    }
                    alert(message);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            alert("이 브라우저는 위치 정보(Geolocation)를 지원하지 않아 내 위치를 찾을 수 없습니다.");
        }
    }


    // 유저의 현재 찜 목록을 가져와 상태 업데이트
    function fetchUserWishes() {
        fetch('/api/wish/list',{
            credentials: 'include'
        })
            .then(res => res.json())
            .then(binIds => {
                userWishes = new Set(binIds);
            })
            .catch(err => console.error('즐겨찾기 목록 로딩 실패:', err));
    }

    // 찜 추가/제거 로직
    function toggleWish(binId) {
        const isWished = userWishes.has(binId);
        const method = isWished ? 'DELETE' : 'POST';
        const apiUrl = `/api/wish/${isWished ? 'remove' : 'add'}/${binId}`;

        fetch(apiUrl, {
            method: method,
            credentials: 'include'
        })
            .then(res => {
                if (res.status === 401) {
                    alert('즐겨찾기 기능을 이용하려면 로그인이 필요합니다.');
                    window.location.href = '/login.html';
                    return Promise.reject('로그인 필요');
                }
                if (!res.ok) return res.json().then(err => Promise.reject(err.message || '처리 실패'));
                return res.json();
            })
            .then(data => {
                alert(data.message);
                const wishBtn = document.getElementById(`iw-wish-btn-${binId}`);
                if (isWished) {
                    userWishes.delete(binId);
                    if (wishBtn) {
                        wishBtn.classList.remove('active');
                        wishBtn.textContent = '☆';
                    }
                } else {
                    userWishes.add(binId);
                    if (wishBtn) {
                        wishBtn.classList.add('active');
                        wishBtn.textContent = '★';
                    }
                }
            })
            .catch(err => {
                if (err !== '로그인 필요') console.error("Wish Error:", err);
            });
    }

    // 마커 클러스터러 생성
    function makeClusterer() {
        return new MarkerClustering({
            minClusterSize: 2,
            maxZoom: 16,
            map: map,
            markers: markers,
            disableClickZoom: false,
            gridSize: 120,
            icons: [{ content: `<div class="cluster"></div>`, size: new naver.maps.Size(40, 40), anchor: new naver.maps.Point(20, 20) }],
            stylingFunction: function (clusterMarker, count) {
                const clusterDiv = clusterMarker.getElement().querySelector('div');
                const size = Math.min(60, 20 + Math.sqrt(count) * 2);
                const fontSize = Math.max(12, size / 3.5);
                clusterDiv.textContent = count;
                clusterDiv.style.width = `${size}px`;
                clusterDiv.style.height = `${size}px`;
                clusterDiv.style.lineHeight = `${size}px`;
                clusterDiv.style.fontSize = `${fontSize}px`;
                if (count < 10) { clusterDiv.style.backgroundColor = '#ffd5e1'; }
                else if (count < 50) { clusterDiv.style.backgroundColor = '#ff88bc'; }
                else if (count < 100) { clusterDiv.style.backgroundColor = '#c637ff'; }
                else if (count < 500) { clusterDiv.style.backgroundColor = '#000bff'; }
                else { clusterDiv.style.backgroundColor = '#739bff'; }
            }
        });
    }

    // 마커 업데이트 (기존 코드 유지)
    function updateMarkers() {
        const bounds = map.getBounds();
        const sw = bounds.getSW();
        const ne = bounds.getNE();
        const apiUrl = `/api/clothing-bins/in-bounds?swLat=${sw.lat()}&swLng=${sw.lng()}&neLat=${ne.lat()}&neLng=${ne.lng()}`;

        fetch(apiUrl)
            .then(res => res.ok ? res.json() : Promise.reject('서버 응답 오류'))
            .then(data => {

                markers.forEach(m => m.setMap(null));
                if (clusterer) {
                    clusterer.setMap(null);
                }
                markers = [];

                markers = data.map(bin => {
                    const marker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(bin.latitude, bin.longitude)
                    });

                    naver.maps.Event.addListener(marker, 'click', () => {
                        if (selectedInfoWindow) selectedInfoWindow.close();

                        currentBinId = bin.id;

                        fetch(`/api/markers/${bin.id}/posts`, { credentials: 'include' })
                            .then(res => res.json())
                            .then(posts => {
                                let postHtml = posts.map(post =>
                                    `<div class="post-item"><strong>${post.authorNickname}</strong>: ${post.content}${post.imageBase64 ? `<br><img src="data:image/jpeg;base64,${post.imageBase64}" style="max-width:100%;"/>` : ''}</div>`
                                ).join('');
                                if(posts.length === 0) postHtml = '<p>아직 등록된 리뷰가 없습니다.</p>';

                                const isWished = userWishes.has(bin.id);
                                const wishClass = isWished ? 'active' : '';
                                const wishText = isWished ? '★' : '☆';
                                const wishBtnHtml = `<button id="iw-wish-btn-${bin.id}" class="iw-wish-btn ${wishClass}" onclick="toggleWish(${bin.id})">${wishText}</button>`;

                                const formHtml = `<div class="post-form"><hr><h5>리뷰 남기기</h5><form id="post-form-${bin.id}"><textarea name="content" rows="3" placeholder="리뷰를 남겨주세요..."></textarea><br><input type="file" name="image" accept="image/*"><br><button type="button" onclick="submitPost(${bin.id})">등록</button></form></div>`;

                                const infoWindowContent = `<div class="iw-inner">${wishBtnHtml}<h4>${bin.roadAddress || bin.landLotAddress}</h4><div class="post-list">${postHtml}</div>${formHtml}</div>`;

                                const infoWindow = new naver.maps.InfoWindow({ content: infoWindowContent, maxWidth: 350 });
                                infoWindow.open(map, marker);
                                selectedInfoWindow = infoWindow;
                            });
                    });
                    return marker;
                });
                clusterer = makeClusterer();
            })
            .catch(err => console.error('마커 로딩 중 오류 발생:', err));
    }

    // 비회원 리뷰 게시글 못올림 함수 (기존 코드 유지)
    function submitPost(binId) {
        const form = document.getElementById(`post-form-${binId}`);
        const formData = new FormData(form);

        fetch(`/api/markers/${binId}/posts`, {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
            .then(res => {
                if (res.status === 401) {
                    alert('리뷰를 작성하려면 로그인이 필요합니다.');
                    window.location.href = '/login.html';
                    return Promise.reject('로그인 필요');
                }
                if (!res.ok) return res.json().then(err => Promise.reject(err.message || '리뷰 등록 실패'));
                return res.json();
            })
            .then(data => {
                alert(data.message);
                if (selectedInfoWindow) {
                    // 정보창을 닫았다가 다시 여는 방식으로 리뷰 목록을 새로고침
                    const markerPosition = selectedInfoWindow.getPosition();
                    selectedInfoWindow.close();
                    const marker = markers.find(m => m.getPosition().equals(markerPosition));
                    if (marker) {
                        naver.maps.Event.trigger(marker, 'click');
                    }
                }
            })
            .catch(err => {
                if (err !== '로그인 필요') console.error("Error:", err);
            });
    }

</script>
</body>
</html>