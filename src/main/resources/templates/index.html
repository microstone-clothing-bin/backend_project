<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>ì˜ë¥˜ ìˆ˜ê±°í•¨ ì§€ë„</title>

    <script th:src="|https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${naverMapsClientId}&callback=initMap|"></script>
    <script th:src="@{/js/markerclustering.js}" defer></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; display: flex; flex-direction: column; }
        #map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .cluster {
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }
        #research-btn {
            position: absolute; top: 60px;
            left: 50%; transform: translateX(-50%); z-index: 100;
            /* ì„ì‹œë¡œ paddingê°’, í°íŠ¸ ì‚¬ì´ì¦ˆ ì¡°ì • (ì¶”í›„ ë””ìì´ë„ˆë‹˜ê³¼ í˜‘ì˜ í•´ì•¼í•¨) */
            padding: 8px 12px;
            font-size: 12px;

            font-weight: bold;
            background-color: #6c5ce7;
            color: white;
            border: none;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        /* ë‚´ ìœ„ì¹˜ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #recenter-btn {
            position: absolute;
            bottom: 20px; /* ì¢Œì¸¡ í•˜ë‹¨ ìœ„ì¹˜ */
            left: 20px;
            z-index: 100;
            padding: 10px;
            font-size: 20px;
            background-color: white;
            color: #6c5ce7; /* ì•„ì´ì½˜ ìƒ‰ìƒ */
            border: 2px solid #6c5ce7;
            border-radius: 50%; /* ì›í˜• ë²„íŠ¼ */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        /* InfoWindow ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
        .iw-inner {
            padding: 10px;
            width: 300px;
            position: relative;
        }
        .iw-inner h4 { margin-top: 0; }
        .post-list { max-height: 150px; overflow-y: auto; margin: 10px 0; }
        .post-item { border-bottom: 1px solid #eee; padding: 5px 0; }
        .post-item strong { color: #6c5ce7; }
        .post-form textarea { width: 95%; margin-bottom: 5px; }
        .post-form input[type="file"] { margin-bottom: 5px; }

        /* InfoWindow ë‚´ë¶€ì˜ ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .iw-wish-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 24px;
            cursor: pointer;
            border: none;
            background: none;
            line-height: 1;
        }
        .iw-wish-btn:not(.active) {
            color: gray;
        }
        .iw-wish-btn.active {
            color: gold;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: headerFragment}"></div>

<div id="map-container">
    <div id="map"></div>
    <button id="research-btn">ì´ ìœ„ì¹˜ì—ì„œ ë‹¤ì‹œ ê²€ìƒ‰</button>
    <button id="recenter-btn" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“</button>
</div>

<script>
    let map; // ì§€ë„ ê°ì²´
    let markers = []; // ë§ˆì»¤ ë°°ì—´
    let clusterer = null; // í´ëŸ¬ìŠ¤í„° ê°ì²´
    let selectedInfoWindow = null; // í˜„ì¬ ì—´ë¦° InfoWindow

    let currentBinId = null; // í˜„ì¬ InfoWindowê°€ ì—´ë¦° ìˆ˜ê±°í•¨ ID ì €ì¥
    let userWishes = new Set(); // ìœ ì €ì˜ í˜„ì¬ ì°œ ëª©ë¡ì„ ì €ì¥í•  Set

    // ì§€ë„ ì´ˆê¸°í™”
    function initMap() {
        map = new naver.maps.Map("map", {
            center: new naver.maps.LatLng(37.6, 127.1), // ì´ˆê¸° ì§€ë„ ì¤‘ì‹¬
            zoom: 13,
            mapDataControl: false,
            zoomControl: true,
            zoomControlOptions: { position: naver.maps.Position.TOP_LEFT }
        });

        // 'ì—¬ê¸°ì„œ ë‹¤ì‹œ ê²€ìƒ‰' ë²„íŠ¼ í´ë¦­ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        document.getElementById('research-btn').addEventListener('click', updateMarkers);

        // 'ë‚´ ìœ„ì¹˜ë¡œ ì´ë™' ë²„íŠ¼ í´ë¦­ ì‹œ í•¨ìˆ˜ ì—°ê²°
        document.getElementById('recenter-btn').addEventListener('click', recenterToMyLocation);

        // ì§€ë„ í´ë¦­ ì‹œ ì—´ë¦° InfoWindow ë‹«ê¸°
        naver.maps.Event.addListener(map, 'click', () => {
            if (selectedInfoWindow) {
                selectedInfoWindow.close();
                selectedInfoWindow = null;
            }
            currentBinId = null;
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì°œ ëª©ë¡ ë¡œë”©
        fetchUserWishes();
        updateMarkers(); // ìµœì´ˆ ë¡œë”© ì‹œ í•œ ë²ˆ ë§ˆì»¤ ë¡œë”©
    }

    function recenterToMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const center = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);

                    // ì§€ë„ë¥¼ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
                    map.setCenter(center);
                    // ì¤Œ ë ˆë²¨ì„ ì ì ˆíˆ í™•ëŒ€ (ex): 16)
                    map.setZoom(16, true);

                },
                (error) => {
                    console.error("Geolocation Error:", error);
                    let message = "ì‚¬ìš©ì ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
                    if (error.code === 1) {
                        message = "ìœ„ì¹˜ ì •ë³´ ì‚¬ìš© ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
                    }
                    alert(message);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´(Geolocation)ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ ë‚´ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }


    // ìœ ì €ì˜ í˜„ì¬ ì°œ ëª©ë¡ì„ ê°€ì ¸ì™€ ìƒíƒœ ì—…ë°ì´íŠ¸
    function fetchUserWishes() {
        fetch('/api/wish/list',{
            credentials: 'include'
        })
            .then(res => res.json())
            .then(binIds => {
                userWishes = new Set(binIds);
            })
            .catch(err => console.error('ì¦ê²¨ì°¾ê¸° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', err));
    }

    // ì°œ ì¶”ê°€/ì œê±° ë¡œì§
    function toggleWish(binId) {
        const isWished = userWishes.has(binId);
        const method = isWished ? 'DELETE' : 'POST';
        const apiUrl = `/api/wish/${isWished ? 'remove' : 'add'}/${binId}`;

        fetch(apiUrl, {
            method: method,
            credentials: 'include'
        })
            .then(res => {
                if (res.status === 401) {
                    alert('ì¦ê²¨ì°¾ê¸° ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login.html';
                    return Promise.reject('ë¡œê·¸ì¸ í•„ìš”');
                }
                if (!res.ok) return res.json().then(err => Promise.reject(err.message || 'ì²˜ë¦¬ ì‹¤íŒ¨'));
                return res.json();
            })
            .then(data => {
                alert(data.message);
                const wishBtn = document.getElementById(`iw-wish-btn-${binId}`);
                if (isWished) {
                    userWishes.delete(binId);
                    if (wishBtn) {
                        wishBtn.classList.remove('active');
                        wishBtn.textContent = 'â˜†';
                    }
                } else {
                    userWishes.add(binId);
                    if (wishBtn) {
                        wishBtn.classList.add('active');
                        wishBtn.textContent = 'â˜…';
                    }
                }
            })
            .catch(err => {
                if (err !== 'ë¡œê·¸ì¸ í•„ìš”') console.error("Wish Error:", err);
            });
    }

    // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±
    function makeClusterer() {
        return new MarkerClustering({
            minClusterSize: 2,
            maxZoom: 16,
            map: map,
            markers: markers,
            disableClickZoom: false,
            gridSize: 120,
            icons: [{ content: `<div class="cluster"></div>`, size: new naver.maps.Size(40, 40), anchor: new naver.maps.Point(20, 20) }],
            stylingFunction: function (clusterMarker, count) {
                const clusterDiv = clusterMarker.getElement().querySelector('div');
                const size = Math.min(60, 20 + Math.sqrt(count) * 2);
                const fontSize = Math.max(12, size / 3.5);
                clusterDiv.textContent = count;
                clusterDiv.style.width = `${size}px`;
                clusterDiv.style.height = `${size}px`;
                clusterDiv.style.lineHeight = `${size}px`;
                clusterDiv.style.fontSize = `${fontSize}px`;
                if (count < 10) { clusterDiv.style.backgroundColor = '#ffd5e1'; }
                else if (count < 50) { clusterDiv.style.backgroundColor = '#ff88bc'; }
                else if (count < 100) { clusterDiv.style.backgroundColor = '#c637ff'; }
                else if (count < 500) { clusterDiv.style.backgroundColor = '#000bff'; }
                else { clusterDiv.style.backgroundColor = '#739bff'; }
            }
        });
    }

    // ë§ˆì»¤ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    function updateMarkers() {
        const bounds = map.getBounds();
        const sw = bounds.getSW();
        const ne = bounds.getNE();
        const apiUrl = `/api/clothing-bins/in-bounds?swLat=${sw.lat()}&swLng=${sw.lng()}&neLat=${ne.lat()}&neLng=${ne.lng()}`;

        fetch(apiUrl)
            .then(res => res.ok ? res.json() : Promise.reject('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜'))
            .then(data => {

                markers.forEach(m => m.setMap(null));
                if (clusterer) {
                    clusterer.setMap(null);
                }
                markers = [];

                markers = data.map(bin => {
                    const marker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(bin.latitude, bin.longitude)
                    });

                    naver.maps.Event.addListener(marker, 'click', () => {
                        if (selectedInfoWindow) selectedInfoWindow.close();

                        currentBinId = bin.id;

                        fetch(`/api/markers/${bin.id}/posts`, { credentials: 'include' })
                            .then(res => res.json())
                            .then(posts => {
                                let postHtml = posts.map(post =>
                                    `<div class="post-item"><strong>${post.authorNickname}</strong>: ${post.content}${post.imageBase64 ? `<br><img src="data:image/jpeg;base64,${post.imageBase64}" style="max-width:100%;"/>` : ''}</div>`
                                ).join('');
                                if(posts.length === 0) postHtml = '<p>ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

                                const isWished = userWishes.has(bin.id);
                                const wishClass = isWished ? 'active' : '';
                                const wishText = isWished ? 'â˜…' : 'â˜†';
                                const wishBtnHtml = `<button id="iw-wish-btn-${bin.id}" class="iw-wish-btn ${wishClass}" onclick="toggleWish(${bin.id})">${wishText}</button>`;

                                const formHtml = `<div class="post-form"><hr><h5>ë¦¬ë·° ë‚¨ê¸°ê¸°</h5><form id="post-form-${bin.id}"><textarea name="content" rows="3" placeholder="ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea><br><input type="file" name="image" accept="image/*"><br><button type="button" onclick="submitPost(${bin.id})">ë“±ë¡</button></form></div>`;

                                const infoWindowContent = `<div class="iw-inner">${wishBtnHtml}<h4>${bin.roadAddress || bin.landLotAddress}</h4><div class="post-list">${postHtml}</div>${formHtml}</div>`;

                                const infoWindow = new naver.maps.InfoWindow({ content: infoWindowContent, maxWidth: 350 });
                                infoWindow.open(map, marker);
                                selectedInfoWindow = infoWindow;
                            });
                    });
                    return marker;
                });
                clusterer = makeClusterer();
            })
            .catch(err => console.error('ë§ˆì»¤ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err));
    }

    // ë¹„íšŒì› ë¦¬ë·° ê²Œì‹œê¸€ ëª»ì˜¬ë¦¼ í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    function submitPost(binId) {
        const form = document.getElementById(`post-form-${binId}`);
        const formData = new FormData(form);

        fetch(`/api/markers/${binId}/posts`, {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
            .then(res => {
                if (res.status === 401) {
                    alert('ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login.html';
                    return Promise.reject('ë¡œê·¸ì¸ í•„ìš”');
                }
                if (!res.ok) return res.json().then(err => Promise.reject(err.message || 'ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨'));
                return res.json();
            })
            .then(data => {
                alert(data.message);
                if (selectedInfoWindow) {
                    // ì •ë³´ì°½ì„ ë‹«ì•˜ë‹¤ê°€ ë‹¤ì‹œ ì—¬ëŠ” ë°©ì‹ìœ¼ë¡œ ë¦¬ë·° ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨
                    const markerPosition = selectedInfoWindow.getPosition();
                    selectedInfoWindow.close();
                    const marker = markers.find(m => m.getPosition().equals(markerPosition));
                    if (marker) {
                        naver.maps.Event.trigger(marker, 'click');
                    }
                }
            })
            .catch(err => {
                if (err !== 'ë¡œê·¸ì¸ í•„ìš”') console.error("Error:", err);
            });
    }

</script>
</body>
</html>