<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>의류 수거함 지도</title>

    <script th:src="|https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${naverMapsClientId}&callback=initMap|"></script>
    <script th:src="@{/js/markerclustering.js}" defer></script>

    <style>
        /* CSS는 변경 없음 */
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; display: flex; flex-direction: column; }
        #map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .cluster {
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }
        #research-btn {
            position: absolute; top: 60px;
            left: 50%; transform: translateX(-50%); z-index: 100;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            background-color: #6c5ce7;
            color: white;
            border: none;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        #recenter-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            padding: 10px;
            font-size: 20px;
            background-color: white;
            color: #6c5ce7;
            border: 2px solid #6c5ce7;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .iw-inner {
            padding: 10px;
            width: 300px;
            position: relative;
        }
        .iw-inner h4 { margin-top: 0; }
        .post-list { max-height: 150px; overflow-y: auto; margin: 10px 0; }
        .post-item { border-bottom: 1px solid #eee; padding: 5px 0; }
        .post-item strong { color: #6c5ce7; }
        .post-form textarea { width: 95%; margin-bottom: 5px; }
        .post-form input[type="file"] { margin-bottom: 5px; }
        .iw-wish-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 24px;
            cursor: pointer;
            border: none;
            background: none;
            line-height: 1;
        }
        .iw-wish-btn:not(.active) { color: gray; }
        .iw-wish-btn.active { color: gold; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: headerFragment}"></div>

<div id="map-container">
    <div id="map"></div>
    <button id="research-btn">이 위치에서 다시 검색</button>
    <button id="recenter-btn" title="내 위치로 이동">📍</button>
</div>

<script>
    // ... (map, markers, clusterer 등 변수 선언은 동일) ...
    let map;
    let markers = [];
    let clusterer = null;
    let selectedInfoWindow = null;
    let currentBinId = null;
    let userWishes = new Set();

    // ... (initMap, recenterToMyLocation, fetchUserWishes, makeClusterer 함수는 동일) ...
    function initMap() {
        map = new naver.maps.Map("map", { center: new naver.maps.LatLng(37.6, 127.1), zoom: 13, mapDataControl: false, zoomControl: true, zoomControlOptions: { position: naver.maps.Position.TOP_LEFT } });
        document.getElementById('research-btn').addEventListener('click', updateMarkers);
        document.getElementById('recenter-btn').addEventListener('click', recenterToMyLocation);
        naver.maps.Event.addListener(map, 'click', () => { if (selectedInfoWindow) { selectedInfoWindow.close(); selectedInfoWindow = null; } currentBinId = null; });
        fetchUserWishes();
        updateMarkers();
    }
    function recenterToMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition( (position) => { const center = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude); map.setCenter(center); map.setZoom(16, true); }, (error) => { console.error("Geolocation Error:", error); let message = "사용자 위치를 찾을 수 없습니다."; if (error.code === 1) { message = "위치 정보 사용 권한이 거부되었습니다."; } alert(message); }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 } );
        } else { alert("이 브라우저는 위치 정보를 지원하지 않습니다."); }
    }
    function fetchUserWishes() {
        fetch('/api/wish/list', { credentials: 'include' }) .then(res => res.json()) .then(binIds => { userWishes = new Set(binIds); }) .catch(err => console.error('즐겨찾기 목록 로딩 실패:', err));
    }
    function makeClusterer() { /* ... 기존과 동일 ... */ return new MarkerClustering({ minClusterSize: 2, maxZoom: 16, map: map, markers: markers, disableClickZoom: false, gridSize: 120, icons: [{ content: `<div class="cluster"></div>`, size: new naver.maps.Size(40, 40), anchor: new naver.maps.Point(20, 20) }], stylingFunction: function (clusterMarker, count) { const clusterDiv = clusterMarker.getElement().querySelector('div'); const size = Math.min(60, 20 + Math.sqrt(count) * 2); const fontSize = Math.max(12, size / 3.5); clusterDiv.textContent = count; clusterDiv.style.width = `${size}px`; clusterDiv.style.height = `${size}px`; clusterDiv.style.lineHeight = `${size}px`; clusterDiv.style.fontSize = `${fontSize}px`; if (count < 10) { clusterDiv.style.backgroundColor = '#ffd5e1'; } else if (count < 50) { clusterDiv.style.backgroundColor = '#ff88bc'; } else if (count < 100) { clusterDiv.style.backgroundColor = '#c637ff'; } else if (count < 500) { clusterDiv.style.backgroundColor = '#000bff'; } else { clusterDiv.style.backgroundColor = '#739bff'; } } }); }


    // VVV 수정된 부분 1 VVV: toggleWish 함수 수정
    function toggleWish(binId) {
        const isWished = userWishes.has(binId);
        // CSRF 보호 때문에 즐겨찾기 추가/삭제는 모두 POST 방식으로 통일하는 것이 간단합니다.
        const method = 'POST';
        const apiUrl = `/api/wish/${isWished ? 'remove' : 'add'}/${binId}`;

        // header.html에 있는 CSRF 토큰을 가져옵니다.
        const csrfToken = document.querySelector('header input[name="_csrf"]')?.value;
        const csrfHeaderName = document.querySelector('header input[name="_csrf_header"]')?.name;

        const headers = {};
        if (csrfHeaderName && csrfToken) {
            headers[csrfHeaderName] = csrfToken;
        }

        fetch(apiUrl, {
            method: method,
            headers: headers,
            credentials: 'include'
        })
            .then(res => {
                // 401(미인증) 또는 403(권한없음/CSRF실패) 상태 코드를 확인합니다.
                if (res.status === 401 || res.status === 403) {
                    alert('즐겨찾기 기능을 이용하려면 로그인이 필요합니다.');
                    window.location.href = '/login.html';
                    return Promise.reject('로그인 필요');
                }
                if (!res.ok) return res.json().then(err => Promise.reject(err.message || '처리 실패'));
                return res.json();
            })
            .then(data => {
                alert(data.message);
                const wishBtn = document.getElementById(`iw-wish-btn-${binId}`);
                if (isWished) {
                    userWishes.delete(binId);
                    if (wishBtn) {
                        wishBtn.classList.remove('active');
                        wishBtn.textContent = '☆';
                    }
                } else {
                    userWishes.add(binId);
                    if (wishBtn) {
                        wishBtn.classList.add('active');
                        wishBtn.textContent = '★';
                    }
                }
            })
            .catch(err => {
                if (err !== '로그인 필요') console.error("Wish Error:", err);
            });
    }

    // ... (updateMarkers 함수는 기존 코드와 거의 동일, 내부의 submitPost 호출 부분만 수정) ...
    function updateMarkers() { const bounds = map.getBounds(); const sw = bounds.getSW(); const ne = bounds.getNE(); const apiUrl = `/api/clothing-bins/in-bounds?swLat=${sw.lat()}&swLng=${sw.lng()}&neLat=${ne.lat()}&neLng=${ne.lng()}`; fetch(apiUrl) .then(res => res.ok ? res.json() : Promise.reject('서버 응답 오류')) .then(data => { markers.forEach(m => m.setMap(null)); if (clusterer) clusterer.setMap(null); markers = []; markers = data.map(bin => { const marker = new naver.maps.Marker({ position: new naver.maps.LatLng(bin.latitude, bin.longitude) }); naver.maps.Event.addListener(marker, 'click', () => { if (selectedInfoWindow) selectedInfoWindow.close(); currentBinId = bin.id; fetch(`/api/markers/${bin.id}/posts`, { credentials: 'include' }) .then(res => res.json()) .then(posts => { let postHtml = posts.map(post => `<div class="post-item"><strong>${post.authorNickname}</strong>: ${post.content}${post.imageBase64 ? `<br><img src="data:image/jpeg;base64,${post.imageBase64}" style="max-width:100%;"/>` : ''}</div>` ).join(''); if(posts.length === 0) postHtml = '<p>아직 등록된 리뷰가 없습니다.</p>'; const isWished = userWishes.has(bin.id); const wishClass = isWished ? 'active' : ''; const wishText = isWished ? '★' : '☆'; const wishBtnHtml = `<button id="iw-wish-btn-${bin.id}" class="iw-wish-btn ${wishClass}" onclick="toggleWish(${bin.id})">${wishText}</button>`;

        // VVV 수정된 부분 2 VVV: submitPost 호출 시 CSRF 토큰을 찾기 위한 정보는 필요 없으므로 제거합니다.
        const formHtml = `<div class="post-form"><hr><h5>리뷰 남기기</h5><form id="post-form-${bin.id}"><textarea name="content" rows="3" placeholder="리뷰를 남겨주세요..."></textarea><br><input type="file" name="image" accept="image/*"><br><button type="button" onclick="submitPost(${bin.id})">등록</button></form></div>`;

        const infoWindowContent = `<div class="iw-inner">${wishBtnHtml}<h4>${bin.roadAddress || bin.landLotAddress}</h4><div class="post-list">${postHtml}</div>${formHtml}</div>`; const infoWindow = new naver.maps.InfoWindow({ content: infoWindowContent, maxWidth: 350 }); infoWindow.open(map, marker); selectedInfoWindow = infoWindow; }); }); return marker; }); clusterer = makeClusterer(); }) .catch(err => console.error('마커 로딩 중 오류 발생:', err)); }

    // VVV 수정된 부분 3 VVV: submitPost 함수 수정
    function submitPost(binId) {
        const form = document.getElementById(`post-form-${binId}`);
        const formData = new FormData(form);

        // header.html에 있는 CSRF 토큰을 가져옵니다.
        const csrfToken = document.querySelector('header input[name="_csrf"]')?.value;
        const csrfHeaderName = document.querySelector('header input[name="_csrf_header"]')?.name;

        const headers = {};
        if (csrfHeaderName && csrfToken) {
            headers[csrfHeaderName] = csrfToken;
        }

        fetch(`/api/markers/${binId}/posts`, {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: formData
        })
            .then(res => {
                if (res.status === 401 || res.status === 403) {
                    alert('리뷰를 작성하려면 로그인이 필요합니다.');
                    window.location.href = '/login.html';
                    return Promise.reject('로그인 필요');
                }
                if (!res.ok) return res.json().then(err => Promise.reject(err.message || '리뷰 등록 실패'));
                return res.json();
            })
            .then(data => {
                alert(data.message);
                if (selectedInfoWindow) {
                    const markerPosition = selectedInfoWindow.getPosition();
                    selectedInfoWindow.close();
                    const marker = markers.find(m => m.getPosition().equals(markerPosition));
                    if (marker) naver.maps.Event.trigger(marker, 'click');
                }
            })
            .catch(err => {
                if (err !== '로그인 필요') console.error("Error:", err);
            });
    }

</script>
</body>
</html>