<!--<!DOCTYPE html>-->
<!--<html lang="ko" xmlns:th="http://www.thymeleaf.org">-->
<!--<head>-->
<!--    <meta charset="UTF-8" /> &lt;!&ndash; 문자 인코딩 UTF-8 &ndash;&gt;-->
<!--    <meta http-equiv="X-UA-Compatible" content="IE=edge"/> &lt;!&ndash; IE 호환 모드 &ndash;&gt;-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0"> &lt;!&ndash; 모바일 뷰포트 설정 &ndash;&gt;-->
<!--    <title>게시물 작성</title> &lt;!&ndash; 브라우저 탭 제목 &ndash;&gt;-->
<!--    <link rel="stylesheet" th:href="@{/css/form.css}"/> &lt;!&ndash; CSS 스타일 적용 &ndash;&gt;-->
<!--</head>-->
<!--<body>-->
<!--<div class="form-container"> &lt;!&ndash; 폼 전체 컨테이너 &ndash;&gt;-->
<!--    <h1>게시물 작성</h1> &lt;!&ndash; 폼 제목 &ndash;&gt;-->

<!--    &lt;!&ndash; 게시물 작성 폼, POST 방식으로 /write 주소 호출 &ndash;&gt;-->
<!--    &lt;!&ndash; enctype="multipart/form-data": 이미지 파일 전송 가능하게 설정 &ndash;&gt;-->
<!--    <form th:action="@{/write}" method="post" enctype="multipart/form-data">-->

<!--        &lt;!&ndash; CSRF 보안 토큰 (POST 전송 시 필수) &ndash;&gt;-->
<!--        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->

<!--        &lt;!&ndash; 작성자 정보 (읽기 전용) &ndash;&gt;-->
<!--        <div>-->
<!--            <label>작성자:</label>-->
<!--            <input type="text" th:value="${loginInfo.nickname}" readonly/>-->
<!--        </div>-->

<!--        &lt;!&ndash; 게시물 제목 입력 &ndash;&gt;-->
<!--        <div>-->
<!--            <label for="title">제목:</label>-->
<!--            <input type="text" id="title" name="title" required />-->
<!--        </div>-->

<!--        &lt;!&ndash; 게시물 내용 입력 &ndash;&gt;-->
<!--        <div>-->
<!--            <label for="content">내용:</label>-->
<!--            <textarea id="content" name="content" cols="50" rows="10" required></textarea>-->
<!--        </div>-->

<!--        &lt;!&ndash; 게시물 이미지 업로드 &ndash;&gt;-->
<!--        <div>-->
<!--            <label for="image">이미지:</label>-->
<!--            <input type="file" id="image" name="image" accept="image/*" />-->
<!--            &lt;!&ndash; accept="image/*": 이미지 파일만 선택 가능 &ndash;&gt;-->
<!--        </div>-->

<!--        <br>-->

<!--        &lt;!&ndash; 제출 버튼 &ndash;&gt;-->
<!--        <button type="submit">등록하기</button>-->
<!--        &lt;!&ndash; 취소 버튼: 게시판 목록 페이지로 이동 &ndash;&gt;-->
<!--        <a th:href="@{/share}" class="btn-cancel">취소</a>-->
<!--    </form>-->
<!--</div>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시물 작성</title>
    <link rel="stylesheet" th:href="@{/css/form.css}"/>

    <script type="text/javascript" th:src="@{'https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=' + ${naverMapsClientId}}"></script>
</head>
<body>
<div class="form-container">
    <h1>게시물 작성</h1>

    <form th:action="@{/write}" method="post" enctype="multipart/form-data" id="postForm">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <input type="hidden" id="selectedLat" name="latitude"/>
        <input type="hidden" id="selectedLng" name="longitude"/>

        <div>
            <label>작성자:</label>
            <input type="text" th:value="${principal.nickname}" readonly/>
        </div>

        <div>
            <label for="title">제목:</label>
            <input type="text" id="title" name="title" required />
        </div>

        <div>
            <label for="content">내용:</label>
            <textarea id="content" name="content" cols="50" rows="10" required></textarea>
        </div>

        <div>
            <label for="image">이미지:</label>
            <input type="file" id="image" name="image" accept="image/*" />
        </div>

        <br>
        <p>게시물과 연관된 수거함 위치를 지도에서 선택해주세요.</p>
        <div id="map" style="width:100%;height:400px;border:1px solid #ccc;"></div>

        <br>
        <button type="submit">등록하기</button>
        <a th:href="@{/share}" class="btn-cancel">취소</a>
    </form>
</div>

<script th:inline="javascript">
    // 서버에서 마커 데이터를 가져옵니다.
    fetch('/api/markers')
        .then(res => res.json())
        .then(markersData => {
            const map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.5665, 126.9780), // 초기 중심 서울 시청
                zoom: 10
            });

            let selectedMarker = null; // 선택된 마커를 추적하기 위한 변수

            markersData.forEach(data => {
                const marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(data.lat, data.lng),
                    map: map,
                    title: data.name
                });

                // 각 마커에 클릭 이벤트를 추가합니다.
                naver.maps.Event.addListener(marker, 'click', function() {
                    // 이전에 선택된 마커가 있다면 원래 아이콘으로 되돌립니다.
                    if (selectedMarker) {
                        selectedMarker.setIcon(null);
                    }

                    // 현재 클릭한 마커를 선택된 마커로 지정합니다.
                    selectedMarker = marker;
                    // 선택된 마커의 아이콘을 시각적으로 변경합니다.
                    selectedMarker.setIcon({
                        content: '<div style="background-color:red;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                        anchor: new naver.maps.Point(8, 8) // 아이콘의 중심점을 맞춤
                    });

                    // VVV 수정된 부분 3 VVV: 숨겨진 input 필드에 위도와 경도 값을 설정합니다.
                    document.getElementById('selectedLat').value = data.lat;
                    document.getElementById('selectedLng').value = data.lng;

                    // ★★★ 중요: content 내용을 JSON으로 덮어쓰는 위험한 로직을 제거했습니다.
                });
            });
        });
</script>
</body>
</html>