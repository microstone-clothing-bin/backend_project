<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>게시물 작성</title>
    <link rel="stylesheet" th:href="@{/css/form.css}"/>

    <script th:src="|https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${naverMapsClientId}&callback=initMap|"></script>
    <script th:src="@{/js/markerclustering.js}" defer></script>

</head>
<body>
<div class="form-container">
    <h1>게시물 작성</h1>

    <form th:action="@{/write}" method="post" enctype="multipart/form-data" id="postForm">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <input type="hidden" id="selectedLat" name="latitude"/>
        <input type="hidden" id="selectedLng" name="longitude"/>

        <div>
            <label>작성자:</label>
            <input type="text" th:value="${loginUser.nickname}" readonly/>
        </div>

        <div>
            <label for="title">제목:</label>
            <input type="text" id="title" name="title" required />
        </div>

        <div>
            <label for="content">내용:</label>
            <textarea id="content" name="content" cols="50" rows="10" required></textarea>
        </div>

        <div>
            <label for="image">이미지:</label>
            <input type="file" id="image" name="image" accept="image/*" />
        </div>

        <br>
        <p>의류수거함 위치</p>
        <div id="map" style="width:100%;height:400px;border:1px solid #ccc;"></div>

        <br>
        <button type="submit">등록하기</button>
        <a th:href="@{/share}" class="btn-cancel">취소</a>
    </form>
</div>

<script th:inline="javascript">
    // 서버에서 마커 데이터를 가져옵니다.
    fetch('/api/markers')
        .then(res => res.json())
        .then(markersData => {
            const map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.5665, 126.9780), // 초기 중심 서울 시청
                zoom: 10
            });

            let selectedMarker = null; // 선택된 마커를 추적하기 위한 변수

            markersData.forEach(data => {
                const marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(data.lat, data.lng),
                    map: map,
                    title: data.name
                });

                // 각 마커에 클릭 이벤트를 추가합니다.
                naver.maps.Event.addListener(marker, 'click', function() {
                    // 이전에 선택된 마커가 있다면 원래 아이콘으로 되돌립니다.
                    if (selectedMarker) {
                        selectedMarker.setIcon(null);
                    }

                    // 현재 클릭한 마커를 선택된 마커로 지정합니다.
                    selectedMarker = marker;
                    // 선택된 마커의 아이콘을 시각적으로 변경합니다.
                    selectedMarker.setIcon({
                        content: '<div style="background-color:red;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                        anchor: new naver.maps.Point(8, 8) // 아이콘의 중심점을 맞춤
                    });

                    // VVV 수정된 부분 3 VVV: 숨겨진 input 필드에 위도와 경도 값을 설정합니다.
                    document.getElementById('selectedLat').value = data.lat;
                    document.getElementById('selectedLng').value = data.lng;

                    // ★★★ 중요: content 내용을 JSON으로 덮어쓰는 위험한 로직을 제거했습니다.
                });
            });
        });
</script>
</body>
</html>