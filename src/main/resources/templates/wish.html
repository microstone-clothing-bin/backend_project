<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>내 즐겨찾기 목록</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        .content-container { width: 80%; margin: 20px auto; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #6c5ce7; padding-bottom: 10px; margin-bottom: 20px; color: #333; }
        .wish-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .wish-item strong { color: #6c5ce7; }
        .remove-btn { background-color: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: headerFragment}"></div>

<div class="content-container">
    <h2>내 즐겨찾기 의류수거함 목록</h2>

    <div th:if="${wishes.isEmpty()}">
        <p>아직 즐겨찾기에 등록된 수거함이 없습니다.</p>
        <p><a th:href="@{/}">지도로 돌아가서 찜해보세요!</a></p>
    </div>

    <div th:each="bin : ${wishes}" class="wish-item">
        <div>
            <strong>[[${bin.roadAddress}]]</strong>
            <span th:if="${bin.roadAddress == null}">[[${bin.landLotAddress}]]</span>
            <p style="font-size: 0.9em; color: #666;">위도: [[${bin.latitude}]] / 경도: [[${bin.longitude}]]</p>
        </div>
        <button class="remove-btn" th:data-bin-id="${bin.id}" onclick="removeWish(this.getAttribute('data-bin-id'))">
            찜 해제
        </button>
    </div>
</div>

<script>
    // [삭제] CSRF는 /api/** 경로에 필요 없으므로 삭제

    function removeWish(binId) {
        if (!confirm('정말로 즐겨찾기를 해제하시겠습니까?')) {
            return;
        }

        // [수정] credentials: 'include' 옵션 추가 및 불필요한 CSRF 헤더 삭제
        fetch(`/api/wish/remove/${binId}`, {
            method: 'DELETE',
            credentials: 'include' // <-- 바로 이 마법의 한 줄! "출입증(쿠키) 챙겨가!"
        })
            .then(res => {
                if (res.status === 401) {
                    alert('로그인이 만료되었거나 권한이 없습니다.');
                    window.location.href = '/login.html';
                    return Promise.reject('로그인 필요');
                }
                if (!res.ok) {
                    // [수정] 에러 응답도 JSON으로 처리
                    return res.json().then(err => Promise.reject(err.message || '해제 실패'));
                }
                // [수정] 성공 응답도 JSON으로 처리
                return res.json();
            })
            .then(data => {
                alert(data.message); // ApiController가 보내준 성공 메시지 출력
                window.location.reload();
            })
            .catch(err => {
                if (err !== '로그인 필요') {
                    console.error("Remove Wish Error:", err);
                    alert('해제 중 오류가 발생했습니다: ' + err);
                }
            });
    }
</script>
</body>
</html>